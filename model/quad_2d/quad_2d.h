#pragma once
#include <iostream>
#include <math.h>
#include <random>
#include <string.h>
#include <yaml-cpp/yaml.h>

/// Represents the swinging arm
class Quad2D {

private:
  // Load YAML file containing quad properties
  YAML::Node yaml_file = YAML::LoadFile("model/parameters.yaml");

  // Position and Orientation ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  // Position
  float x = 0; // m
  float z = 0; // m

  // Velocities
  float x_dot = 0; // m/s
  float z_dot = 0; // m/s

  // Accelerations
  float x_ddot = 0; // m/s^2
  float z_ddot = 0; // m/s^2

  // Orientation
  float beta = 0;

  // Angular velocity
  float beta_dot = 0;

  // Angular acceleration
  float beta_ddot = 0;

  // Motor Speeds
  float motor_speeds[4] = {0, 0, 0, 0};

  // Geometrical properties
  float arm_length_ = yaml_file["arm_length"].as<float>(); // [m]
  float inertia_2d_ = yaml_file["inertia_2d"].as<float>(); // [kg m^2]

  /// Thrust generated by the motor propellor pair
  float actual_thrust = 0;
  float actual_thrust_dot = 0;

  /// Torque generated by the motor propellor pair
  float actual_torque = 0;

  // Controller commands
  // float commanded_thrust = 0;
  // float commanded_torque = 0;

  // Variables for dynamics function ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  // Mass of the quadcopter
  float mass_ = yaml_file["mass"].as<float>();

  // Gravitational constant
  constexpr static float g = 9.81;

  // Air drag coefficient
  float drag_coeff_ = yaml_file["drag_coeff"].as<float>();

  // Maximum thrust can be produced by the motors
  float motor_thrust_max_ = yaml_file["motor_thrust_max"].as<float>();

  // Maximum thrust can be produced by the motors
  float motor_thrust_min_ = yaml_file["motor_thrust_min"].as<float>();

  // Maximum thrust can be produced by the motors
  float thrust_max_ = motor_thrust_max_ * 4;

  // Maximum thrust can be produced by the motors
  float thrust_min_ = motor_thrust_min_ * 4;

  // Maximum thrust can be produced by the motors
  float roll_max_ = yaml_file["roll_max"].as<float>();

  // Maximum thrust can be produced by the motors
  const float torque_max_ =
      (motor_thrust_max_ - motor_thrust_min_) * arm_length_;

  // Variables for motor dynamics

  // Relation btw square of motor speed and motor thrust
  const float k_f_ = 6.11 * exp(-8);
  // float k_f = yaml_file["k_f"].as<float>();

  // Time constant of motor (approximated as 1st order system)
  const float motor_time_constant =
      yaml_file["motor_time_constant"].as<float>();

  float motor_thrusts[4] = {0, 0, 0, 0};

  // Measured states ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  float x_mes_ = 0;
  float x_dot_mes_ = 0;

  float z_mes_ = 0;
  float z_dot_mes_ = 0;

  float beta_mes_ = 0;
  float beta_dot_mes_ = 0;

public:
  /// Set quadcopter parameters
  void set_initial_conditions(std::string path);

  /// Dynamics of the 2D quadcopter
  void dynamics(float thrust_input, float torque_input);

  /// Dynamics function that accepts motor commands instead of thrusts
  void new_dynamics(float motor_speed[4]);

  // Numerical integration
  void euler_step(float dt);

  // Get sensor measurements by adding artifical noise to the sensors
  void sensor_read();

private:
  void motor_speed_to_thrust_map(float motor_commands[4]);

  // First order dynamics of BLDC motor
  // void motor_dynamics();

public:
  /// Getter function
  float x_mes() const { return x_mes_; }
  /// Getter function
  float x_dot_mes() const { return x_dot_mes_; }
  /// Getter function
  float z_mes() const { return z_mes_; }
  /// Getter function
  float z_dot_mes() const { return z_dot_mes_; }
  /// Getter function
  float beta_mes() const { return beta_mes_; }
  /// Getter function
  float beta_dot_mes() const { return beta_dot_mes_; }
  /// Getter function
  float thrust_max() const { return thrust_max_; }
  /// Getter function
  float thrust_min() const { return thrust_min_; }
  /// Getter function
  float torque_max() const { return torque_max_; }
  /// Getter function
  float roll_max() const { return roll_max_; }
  /// Getter function
  float mass() const { return mass_; }
  /// Getter function
  float k_f() const { return k_f_; }
  /// Getter function
  float arm_length() const { return arm_length_; }

  /// Setter function
  void set_x_mes(float x_mes) { x_mes_ = x_mes; }
  /// Setter function
  void set_x_dot_mes(float x_mes) { x_mes_ = x_mes; }
  /// Setter function
  void set_z_mes(float z_mes) { z_mes_ = z_mes; }
  /// Setter function
  void set_z_dot_mes(float z_mes) { z_mes_ = z_mes; }
  /// Setter function
  void set_beta_mes(float beta_mes) { beta_mes_ = beta_mes; }
  /// Setter function
  void set_beta_dot_mes(float beta_mes) { beta_mes_ = beta_mes; }
  /// Setter function
  void set_mass(float mass) { mass_ = mass; }
};